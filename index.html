<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Carrom Tournament Manager Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap');

        :root {
            --primary: #2563eb;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientMove 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
        }

        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.98), rgba(124, 58, 237, 0.98));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 3.5em;
            color: white;
            margin-bottom: 10px;
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.3em;
            font-weight: 600;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            font-size: 0.85em;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: 2px;
        }

        .nav-item {
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: var(--dark);
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            min-height: 700px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, var(--primary), var(--secondary), transparent) 1;
        }

        .section-header h2 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            font-weight: 900;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 800;
            color: var(--dark);
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 3px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .match-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 2px solid var(--border);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .score-section {
            margin: 20px 0;
        }

        .board-row {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 150px 150px 150px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .board-row input {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .score-display {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
            border-radius: 12px;
            margin: 15px 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        th:first-child { border-radius: 16px 0 0 0; }
        th:last-child { border-radius: 0 16px 0 0; }

        td {
            padding: 16px;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td {
            background: var(--light);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 800;
            text-transform: uppercase;
        }

        .badge-live {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            animation: pulse 2s infinite;
        }

        .badge-completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .badge-scheduled {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.3s;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideUp 0.3s;
            border-left: 5px solid var(--success);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .category-btn {
            padding: 20px;
            border: 3px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 700;
        }

        .category-btn:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
            transform: translateY(-3px);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .board-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ CARROM TOURNAMENT MANAGER</h1>
            <p>Professional Carrom Tournament & Match Management System</p>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <h3>Menu</h3>
                <div class="nav-item active" onclick="showSection('home')">
                    <span>üè†</span> Home
                </div>
                <div class="nav-item" onclick="showSection('generic')">
                    <span>üéÆ</span> Generic Matches
                </div>
                <div class="nav-item" onclick="showSection('tournament')">
                    <span>üèÜ</span> Tournament Setup
                </div>
                <div class="nav-item" onclick="showSection('matches')">
                    <span>üéØ</span> Tournament Matches
                </div>
                <div class="nav-item" onclick="showSection('standings')">
                    <span>üìä</span> Standings
                </div>
                <div class="nav-item" onclick="showSection('history')">
                    <span>üìö</span> History
                </div>
            </div>

            <div class="content-area">
                <!-- Home -->
                <div id="home" class="content-section active">
                    <div class="section-header">
                        <h2>Welcome to Carrom Manager</h2>
                        <p>Professional tournament and match management</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="card" style="cursor: pointer;" onclick="showSection('generic')">
                            <h2 style="font-size: 3em; margin-bottom: 15px;">üéÆ</h2>
                            <h3 style="color: var(--primary); margin-bottom: 10px;">Generic Matches</h3>
                            <p style="opacity: 0.7; line-height: 1.6;">Quick casual games - Singles & Doubles. No historical data storage.</p>
                            <ul style="margin-top: 15px; padding-left: 20px; opacity: 0.7;">
                                <li>Singles & Doubles</li>
                                <li>Best of 3/8/Full board</li>
                                <li>Queen tracking per board</li>
                                <li>No historical storage</li>
                            </ul>
                        </div>

                        <div class="card" style="cursor: pointer;" onclick="showSection('tournament')">
                            <h2 style="font-size: 3em; margin-bottom: 15px;">üèÜ</h2>
                            <h3 style="color: var(--primary); margin-bottom: 10px;">Tournament Matches</h3>
                            <p style="opacity: 0.7; line-height: 1.6;">Full tournament management with draws, groups, and categories.</p>
                            <ul style="margin-top: 15px; padding-left: 20px; opacity: 0.7;">
                                <li>Multiple categories</li>
                                <li>Automatic draw generation</li>
                                <li>Historical data (1 year)</li>
                                <li>Complete tournament map</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Generic Matches -->
                <div id="generic" class="content-section">
                    <div class="section-header">
                        <h2>Generic Matches</h2>
                        <p>Quick casual games - No historical data stored</p>
                    </div>

                    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                        <button class="btn btn-primary" onclick="startGenericMatch('singles')">
                            üéÆ New Singles Match
                        </button>
                        <button class="btn btn-primary" onclick="startGenericMatch('doubles')">
                            üë• New Doubles Match
                        </button>
                        <button class="btn btn-secondary" onclick="exportGenericJSON()">
                            üì• Export JSON
                        </button>
                    </div>

                    <div id="genericMatchesList"></div>
                </div>

                <!-- Tournament Setup -->
                <div id="tournament" class="content-section">
                    <div class="section-header">
                        <h2>Tournament Setup</h2>
                        <p>Create and configure your tournament</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tournament Name</label>
                            <input type="text" id="tournamentName" placeholder="e.g., National Carrom Championship 2024">
                        </div>

                        <div class="form-group">
                            <label>Tournament Format</label>
                            <select id="tournamentFormat">
                                <option value="rr">Round Robin</option>
                                <option value="group">Group Level</option>
                                <option value="knockout">Knockout</option>
                                <option value="quarters">Quarter Finals</option>
                                <option value="semis">Semi Finals</option>
                                <option value="finals">Finals</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="tournamentDate">
                        </div>

                        <div class="form-group">
                            <label>Venue</label>
                            <input type="text" id="tournamentVenue" placeholder="Tournament venue">
                        </div>
                    </div>

                    <h3 style="margin: 30px 0 15px 0;">Select Categories</h3>
                    <div class="category-selector">
                        <div class="category-btn" onclick="toggleCategory(this, 'mens-singles')">
                            üë® Men's Singles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'mens-doubles')">
                            üë®‚Äçüë® Men's Doubles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'womens-singles')">
                            üë© Women's Singles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'womens-doubles')">
                            üë©‚Äçüë© Women's Doubles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'kids-singles')">
                            üßí Kids Singles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'kids-doubles')">
                            üßíüßí Kids Doubles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'mixed-doubles')">
                            üë• Mixed Doubles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'sr-citizen-singles')">
                            üë¥ Sr Citizen Singles
                        </div>
                        <div class="category-btn" onclick="toggleCategory(this, 'sr-citizen-doubles')">
                            üë¥üëµ Sr Citizen Doubles
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <label>Total Participants</label>
                        <input type="number" id="totalParticipants" min="2" value="8">
                    </div>

                    <div class="form-group">
                        <label>Participants Per Group (for group format)</label>
                        <input type="number" id="groupSize" min="2" value="4">
                    </div>

                    <button class="btn btn-success" onclick="createTournament()">
                        ‚ú® Create Tournament
                    </button>
                </div>

                <!-- Tournament Matches -->
                <div id="matches" class="content-section">
                    <div class="section-header">
                        <h2>Tournament Matches</h2>
                        <p>Manage tournament games with full scoring</p>
                    </div>

                    <div id="tournamentInfo" style="display: none;">
                        <div class="card">
                            <h3 id="currentTournamentName"></h3>
                            <p id="currentTournamentDetails"></p>
                        </div>

                        <div style="margin: 20px 0;">
                            <button class="btn btn-primary" onclick="generateDraws()">
                                üé≤ Generate Draws
                            </button>
                            <button class="btn btn-primary" onclick="addTournamentMatch()">
                                ‚ûï Add Match
                            </button>
                            <button class="btn btn-secondary" onclick="exportTournamentJSON()">
                                üì• Export Tournament
                            </button>
                        </div>

                        <div id="tournamentMatchesList"></div>
                    </div>

                    <div id="noTournament" style="text-align: center; padding: 60px;">
                        <h3 style="opacity: 0.6;">No tournament created yet</h3>
                        <p style="opacity: 0.5; margin: 15px 0;">Go to Tournament Setup to create one</p>
                        <button class="btn btn-primary" onclick="showSection('tournament')">
                            üèÜ Create Tournament
                        </button>
                    </div>
                </div>

                <!-- Standings -->
                <div id="standings" class="content-section">
                    <div class="section-header">
                        <h2>Tournament Standings</h2>
                        <p>Current rankings and results</p>
                    </div>
                    <div id="standingsContent"></div>
                </div>

                <!-- History -->
                <div id="history" class="content-section">
                    <div class="section-header">
                        <h2>Match History</h2>
                        <p>Tournament matches stored for 1 year</p>
                    </div>
                    <div id="historyContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Global State
        let genericMatches = [];
        let tournament = null;
        let tournamentMatches = [];
        let selectedCategories = [];
        let matchHistory = [];

        // Initialize
        window.onload = function() {
            loadData();
            updateUI();
        };

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            updateUI();
        }

        // Category Toggle
        function toggleCategory(element, category) {
            element.classList.toggle('active');
            
            if (element.classList.contains('active')) {
                if (!selectedCategories.includes(category)) {
                    selectedCategories.push(category);
                }
            } else {
                selectedCategories = selectedCategories.filter(c => c !== category);
            }
        }

        // Create Tournament
        function createTournament() {
            const name = document.getElementById('tournamentName').value;
            const format = document.getElementById('tournamentFormat').value;
            const date = document.getElementById('tournamentDate').value;
            const venue = document.getElementById('tournamentVenue').value;
            const participants = parseInt(document.getElementById('totalParticipants').value);
            const groupSize = parseInt(document.getElementById('groupSize').value);

            if (!name || selectedCategories.length === 0) {
                showToast('Please enter tournament name and select at least one category', '‚ùå');
                return;
            }

            tournament = {
                name, format, date, venue,
                participants, groupSize,
                categories: [...selectedCategories],
                created: new Date().toISOString()
            };

            saveData();
            showToast('Tournament created successfully!', '‚úÖ');
            showSection('matches');
            updateUI();
        }

        // Start Generic Match
        function startGenericMatch(type) {
            const match = {
                id: Date.now(),
                type: type,
                date: new Date().toISOString(),
                player1: '',
                player2: '',
                player3: type === 'doubles' ? '' : null,
                player4: type === 'doubles' ? '' : null,
                bestOf: 3,
                boards: [],
                status: 'setup',
                isGeneric: true
            };

            openMatchModal(match);
        }

        // Add Tournament Match
        function addTournamentMatch() {
            if (!tournament) {
                showToast('Create a tournament first!', '‚ùå');
                return;
            }

            const match = {
                id: Date.now(),
                tournamentId: tournament.created,
                type: 'singles',
                date: new Date().toISOString(),
                matchTitle: '',
                player1: '',
                player2: '',
                player3: null,
                player4: null,
                bestOf: 3,
                boards: [],
                status: 'setup',
                isGeneric: false
            };

            openMatchModal(match);
        }

        // Open Match Modal
        function openMatchModal(match) {
            const modal = document.getElementById('matchModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            title.textContent = match.status === 'setup' ? 'Setup Match' : 'Match in Progress';

            if (match.status === 'setup') {
                content.innerHTML = `
                    <div class="form-group">
                        <label>${match.isGeneric ? 'Match Type' : 'Match Title'}</label>
                        ${match.isGeneric ? `
                            <select id="matchType" onchange="updateMatchType(${match.id})">
                                <option value="singles" ${match.type === 'singles' ? 'selected' : ''}>Singles</option>
                                <option value="doubles" ${match.type === 'doubles' ? 'selected' : ''}>Doubles</option>
                            </select>
                        ` : `
                            <input type="text" id="matchTitle" value="${match.matchTitle || ''}" placeholder="e.g., Quarter Final Match 1">
                        `}
                    </div>

                    <div class="form-group">
                        <label>Player 1 Name</label>
                        <input type="text" id="player1" value="${match.player1}" placeholder="Enter name">
                    </div>

                    <div class="form-group">
                        <label>Player 2 Name</label>
                        <input type="text" id="player2" value="${match.player2}" placeholder="Enter name">
                    </div>

                    ${match.type === 'doubles' ? `
                        <div class="form-group">
                            <label>Player 3 Name (Team 1)</label>
                            <input type="text" id="player3" value="${match.player3 || ''}" placeholder="Enter name">
                        </div>

                        <div class="form-group">
                            <label>Player 4 Name (Team 2)</label>
                            <input type="text" id="player4" value="${match.player4 || ''}" placeholder="Enter name">
                        </div>
                    ` : ''}

                    <div class="form-group">
                        <label>Best of</label>
                        <select id="bestOf">
                            <option value="3">Best of 3</option>
                            <option value="8">Best of 8</option>
                            <option value="full">Full Board</option>
                        </select>
                    </div>

                    <button class="btn btn-success" onclick="startScoring(${match.id})">
                        ‚ñ∂Ô∏è Start Match
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        Cancel
                    </button>
                `;
            } else {
                renderMatchScoring(match);
            }

            modal.classList.add('active');
        }

        // Start Scoring
        function startScoring(matchId) {
            const player1 = document.getElementById('player1').value;
            const player2 = document.getElementById('player2').value;
            const bestOf = document.getElementById('bestOf').value;
            
            if (!player1 || !player2) {
                showToast('Please enter player names', '‚ùå');
                return;
            }

            let match = genericMatches.find(m => m.id === matchId);
            if (!match) {
                match = tournamentMatches.find(m => m.id === matchId);
            }
            
            if (!match) {
                // Create new match
                const matchType = document.getElementById('matchType')?.value || 'singles';
                const matchTitle = document.getElementById('matchTitle')?.value || '';
                
                match = {
                    id: matchId,
                    type: matchType,
                    date: new Date().toISOString(),
                    matchTitle: matchTitle,
                    player1: player1,
                    player2: player2,
                    player3: matchType === 'doubles' ? (document.getElementById('player3')?.value || '') : null,
                    player4: matchType === 'doubles' ? (document.getElementById('player4')?.value || '') : null,
                    bestOf: bestOf,
                    boards: [],
                    status: 'live',
                    isGeneric: !matchTitle
                };

                // Add initial boards based on bestOf
                const numBoards = bestOf === 'full' ? 1 : parseInt(bestOf);
                for (let i = 1; i <= numBoards; i++) {
                    match.boards.push({
                        board: i,
                        breakBy: '',
                        player1Queen: 0,
                        player2Queen: 0,
                        player1Score: 0,
                        player2Score: 0
                    });
                }

                if (match.isGeneric) {
                    genericMatches.push(match);
                } else {
                    tournamentMatches.push(match);
                }
            } else {
                match.player1 = player1;
                match.player2 = player2;
                match.bestOf = bestOf;
                match.status = 'live';
            }

            saveData();
            renderMatchScoring(match);
        }

        // Render Match Scoring
        function renderMatchScoring(match) {
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');

            title.textContent = `${match.matchTitle || 'Match'} - ${match.player1} vs ${match.player2}`;

            let html = `
                <div class="match-card">
                    <div class="match-header">
                        <div>
                            <strong>${match.type === 'doubles' ? 'Doubles' : 'Singles'} Match</strong>
                            ${match.matchTitle ? `<br><small>${match.matchTitle}</small>` : ''}
                        </div>
                        <span class="badge badge-live">üî¥ LIVE</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="text-align: center;">
                            <h3>${match.player1}${match.player3 ? ` & ${match.player3}` : ''}</h3>
                            <div class="score-display" id="total1">0</div>
                        </div>
                        <div style="text-align: center;">
                            <h3>${match.player2}${match.player4 ? ` & ${match.player4}` : ''}</h3>
                            <div class="score-display" id="total2">0</div>
                        </div>
                    </div>

                    <div class="score-section">
                        <h4 style="margin-bottom: 15px;">Board Scores</h4>
                        <div style="display: grid; gap: 10px;">
                            <div class="board-row" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-weight: 800;">
                                <div>Board</div>
                                <div>Break By</div>
                                <div>Player</div>
                                <div>Queen P1/Team1</div>
                                <div>Queen P2/Team2</div>
                                <div>Score</div>
                            </div>
            `;

            match.boards.forEach((board, index) => {
                html += `
                    <div class="board-row">
                        <div><strong>Board ${board.board}</strong></div>
                        <div>
                            <input type="text" value="${board.breakBy}" 
                                   onchange="updateBoard(${match.id}, ${index}, 'breakBy', this.value)"
                                   placeholder="Name">
                        </div>
                        <div>
                            ${match.type === 'doubles' ? `
                                <select onchange="updateBoard(${match.id}, ${index}, 'player', this.value)">
                                    <option value="">Select</option>
                                    <option value="${match.player1}">${match.player1}</option>
                                    <option value="${match.player2}">${match.player2}</option>
                                    <option value="${match.player3}">${match.player3}</option>
                                    <option value="${match.player4}">${match.player4}</option>
                                </select>
                            ` : '-'}
                        </div>
                        <div>
                            <input type="number" value="${board.player1Queen}" min="0"
                                   onchange="updateBoard(${match.id}, ${index}, 'player1Queen', this.value)"
                                   placeholder="0">
                        </div>
                        <div>
                            <input type="number" value="${board.player2Queen}" min="0"
                                   onchange="updateBoard(${match.id}, ${index}, 'player2Queen', this.value)"
                                   placeholder="0">
                        </div>
                        <div>
                            <input type="number" value="${board.player1Score}" min="0" style="margin-bottom: 5px;"
                                   onchange="updateBoard(${match.id}, ${index}, 'player1Score', this.value)"
                                   placeholder="P1">
                            <input type="number" value="${board.player2Score}" min="0"
                                   onchange="updateBoard(${match.id}, ${index}, 'player2Score', this.value)"
                                   placeholder="P2">
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <div style="margin-top: 25px; display: flex; gap: 15px;">
                        <button class="btn btn-success" onclick="completeMatch(${match.id})">
                            ‚úÖ Complete Match
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">
                            üíæ Save & Close
                        </button>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            calculateTotals(match.id);
        }

        // Update Board
        function updateBoard(matchId, boardIndex, field, value) {
            let match = genericMatches.find(m => m.id === matchId);
            if (!match) {
                match = tournamentMatches.find(m => m.id === matchId);
            }

            if (match && match.boards[boardIndex]) {
                match.boards[boardIndex][field] = value;
                saveData();
                calculateTotals(matchId);
            }
        }

        // Calculate Totals
        function calculateTotals(matchId) {
            let match = genericMatches.find(m => m.id === matchId);
            if (!match) {
                match = tournamentMatches.find(m => m.id === matchId);
            }

            if (!match) return;

            let total1 = 0, total2 = 0;
            
            match.boards.forEach(board => {
                total1 += parseInt(board.player1Score) || 0;
                total1 += parseInt(board.player1Queen) || 0;
                total2 += parseInt(board.player2Score) || 0;
                total2 += parseInt(board.player2Queen) || 0;
            });

            const total1El = document.getElementById('total1');
            const total2El = document.getElementById('total2');
            
            if (total1El) total1El.textContent = total1;
            if (total2El) total2El.textContent = total2;
        }

        // Complete Match
        function completeMatch(matchId) {
            let match = genericMatches.find(m => m.id === matchId);
            let isTournament = false;
            
            if (!match) {
                match = tournamentMatches.find(m => m.id === matchId);
                isTournament = true;
            }

            if (!match) return;

            match.status = 'completed';
            match.completedDate = new Date().toISOString();

            // Store tournament matches in history
            if (isTournament) {
                matchHistory.push({...match});
                // Keep only 1 year of data
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                matchHistory = matchHistory.filter(m => new Date(m.completedDate) > oneYearAgo);
            }

            saveData();
            showToast('Match completed!', 'üéâ');
            closeModal();
            updateUI();
        }

        // Generate Draws
        function generateDraws() {
            if (!tournament) return;

            const participants = tournament.participants;
            const format = tournament.format;

            let draws = [];
            
            // Simple draw generation
            for (let i = 1; i <= participants; i += 2) {
                if (i + 1 <= participants) {
                    const match = {
                        id: Date.now() + i,
                        tournamentId: tournament.created,
                        type: 'singles',
                        date: tournament.date,
                        matchTitle: `${format.toUpperCase()} Match ${Math.ceil(i/2)}`,
                        player1: `Player ${i}`,
                        player2: `Player ${i+1}`,
                        player3: null,
                        player4: null,
                        bestOf: 3,
                        boards: [],
                        status: 'scheduled',
                        isGeneric: false
                    };
                    tournamentMatches.push(match);
                }
            }

            saveData();
            showToast(`Generated ${Math.floor(participants/2)} matches!`, '‚úÖ');
            updateUI();
        }

        // Update UI
        function updateUI() {
            updateGenericMatchesList();
            updateTournamentMatchesList();
            updateStandings();
            updateHistory();
        }

        // Update Generic Matches List
        function updateGenericMatchesList() {
            const container = document.getElementById('genericMatchesList');
            
            if (genericMatches.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; opacity: 0.6;">No generic matches yet. Start a new match!</p>';
                return;
            }

            let html = '';
            genericMatches.forEach(match => {
                const badge = match.status === 'live' ? 'badge-live' : 
                             match.status === 'completed' ? 'badge-completed' : 'badge-scheduled';
                
                html += `
                    <div class="match-card">
                        <div class="match-header">
                            <div>
                                <strong>${match.type === 'doubles' ? 'Doubles' : 'Singles'}</strong>
                                <br><small>${new Date(match.date).toLocaleString()}</small>
                            </div>
                            <span class="badge ${badge}">
                                ${match.status === 'live' ? 'üî¥ LIVE' : 
                                  match.status === 'completed' ? '‚úÖ Done' : 'üìÖ Scheduled'}
                            </span>
                        </div>
                        <div>
                            <strong>${match.player1}${match.player3 ? ` & ${match.player3}` : ''}</strong>
                            vs
                            <strong>${match.player2}${match.player4 ? ` & ${match.player4}` : ''}</strong>
                        </div>
                        ${match.status !== 'setup' ? `
                            <button class="btn btn-primary" style="margin-top: 15px;" onclick="openMatchModal(genericMatches.find(m => m.id === ${match.id}))">
                                ${match.status === 'completed' ? 'üëÅÔ∏è View' : 'üìä Continue'}
                            </button>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update Tournament Matches List
        function updateTournamentMatchesList() {
            if (!tournament) {
                document.getElementById('tournamentInfo').style.display = 'none';
                document.getElementById('noTournament').style.display = 'block';
                return;
            }

            document.getElementById('tournamentInfo').style.display = 'block';
            document.getElementById('noTournament').style.display = 'none';

            document.getElementById('currentTournamentName').textContent = tournament.name;
            document.getElementById('currentTournamentDetails').textContent = 
                `${tournament.format.toUpperCase()} ‚Ä¢ ${new Date(tournament.date).toLocaleDateString()} ‚Ä¢ ${tournament.venue || 'Venue TBD'}`;

            const container = document.getElementById('tournamentMatchesList');
            
            if (tournamentMatches.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; opacity: 0.6;">No matches yet. Generate draws or add manually!</p>';
                return;
            }

            let html = '';
            tournamentMatches.forEach(match => {
                const badge = match.status === 'live' ? 'badge-live' : 
                             match.status === 'completed' ? 'badge-completed' : 'badge-scheduled';
                
                html += `
                    <div class="match-card">
                        <div class="match-header">
                            <div>
                                <strong>${match.matchTitle || 'Match'}</strong>
                                <br><small>${new Date(match.date).toLocaleDateString()}</small>
                            </div>
                            <span class="badge ${badge}">
                                ${match.status === 'live' ? 'üî¥ LIVE' : 
                                  match.status === 'completed' ? '‚úÖ Done' : 'üìÖ Scheduled'}
                            </span>
                        </div>
                        <div>
                            <strong>${match.player1}${match.player3 ? ` & ${match.player3}` : ''}</strong>
                            vs
                            <strong>${match.player2}${match.player4 ? ` & ${match.player4}` : ''}</strong>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="openMatchModal(tournamentMatches.find(m => m.id === ${match.id}))">
                            ${match.status === 'completed' ? 'üëÅÔ∏è View' : match.status === 'scheduled' ? '‚ñ∂Ô∏è Start' : 'üìä Continue'}
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update Standings
        function updateStandings() {
            const container = document.getElementById('standingsContent');
            
            if (!tournament || tournamentMatches.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; opacity: 0.6;">No tournament data yet!</p>';
                return;
            }

            // Calculate standings
            const playerStats = {};
            
            tournamentMatches.filter(m => m.status === 'completed').forEach(match => {
                let p1Score = 0, p2Score = 0;
                
                match.boards.forEach(board => {
                    p1Score += (parseInt(board.player1Score) || 0) + (parseInt(board.player1Queen) || 0);
                    p2Score += (parseInt(board.player2Score) || 0) + (parseInt(board.player2Queen) || 0);
                });

                if (!playerStats[match.player1]) {
                    playerStats[match.player1] = { name: match.player1, wins: 0, losses: 0, points: 0 };
                }
                if (!playerStats[match.player2]) {
                    playerStats[match.player2] = { name: match.player2, wins: 0, losses: 0, points: 0 };
                }

                playerStats[match.player1].points += p1Score;
                playerStats[match.player2].points += p2Score;

                if (p1Score > p2Score) {
                    playerStats[match.player1].wins++;
                    playerStats[match.player2].losses++;
                } else if (p2Score > p1Score) {
                    playerStats[match.player2].wins++;
                    playerStats[match.player1].losses++;
                }
            });

            const sortedPlayers = Object.values(playerStats).sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return b.points - a.points;
            });

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Wins</th>
                                <th>Losses</th>
                                <th>Total Points</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedPlayers.forEach((player, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><strong>${player.name}</strong></td>
                        <td>${player.wins}</td>
                        <td>${player.losses}</td>
                        <td style="color: var(--primary); font-weight: 900; font-size: 1.2em;">${player.points}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update History
        function updateHistory() {
            const container = document.getElementById('historyContent');
            
            if (matchHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; opacity: 0.6;">No historical data yet. Tournament matches will be stored here for 1 year.</p>';
                return;
            }

            let html = '';
            matchHistory.forEach(match => {
                html += `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${match.matchTitle || 'Match'}</strong>
                                <br><small>${new Date(match.completedDate).toLocaleString()}</small>
                            </div>
                            <span class="badge badge-completed">‚úÖ Completed</span>
                        </div>
                        <div style="margin-top: 10px;">
                            ${match.player1} vs ${match.player2}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Export Functions
        function exportGenericJSON() {
            if (genericMatches.length === 0) {
                showToast('No generic matches to export', '‚ùå');
                return;
            }

            const data = JSON.stringify(genericMatches, null, 2);
            downloadJSON(data, 'carrom_generic_matches.json');
        }

        function exportTournamentJSON() {
            if (!tournament) {
                showToast('No tournament to export', '‚ùå');
                return;
            }

            const data = {
                tournament,
                matches: tournamentMatches,
                history: matchHistory
            };

            const json = JSON.stringify(data, null, 2);
            downloadJSON(json, `${tournament.name.replace(/\s+/g, '_')}.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Exported successfully!', 'üì•');
        }

        // Modal Functions
        function closeModal() {
            document.getElementById('matchModal').classList.remove('active');
            updateUI();
        }

        window.onclick = function(event) {
            const modal = document.getElementById('matchModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Toast
        function showToast(message, icon = '‚úÖ') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span style="font-size: 1.5em;">${icon}</span>
                <span style="font-weight: 600;">${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Storage
        function saveData() {
            localStorage.setItem('carromGenericMatches', JSON.stringify(genericMatches));
            localStorage.setItem('carromTournament', JSON.stringify(tournament));
            localStorage.setItem('carromTournamentMatches', JSON.stringify(tournamentMatches));
            localStorage.setItem('carromMatchHistory', JSON.stringify(matchHistory));
        }

        function loadData() {
            const saved1 = localStorage.getItem('carromGenericMatches');
            const saved2 = localStorage.getItem('carromTournament');
            const saved3 = localStorage.getItem('carromTournamentMatches');
            const saved4 = localStorage.getItem('carromMatchHistory');
            
            if (saved1) genericMatches = JSON.parse(saved1);
            if (saved2) tournament = JSON.parse(saved2);
            if (saved3) tournamentMatches = JSON.parse(saved3);
            if (saved4) {
                matchHistory = JSON.parse(saved4);
                // Clean old data
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                matchHistory = matchHistory.filter(m => new Date(m.completedDate) > oneYearAgo);
                saveData();
            }
        }
    </script>
</body>
</html>